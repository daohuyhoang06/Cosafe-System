<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EWG Skin Deep</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header class="header">
      <div class="logo">
        <a href="home-page.html" class="logo-link">EWG Skin Deep</a>
      </div>
    </header>

    <div class="main-content">
      <form
        action="searching-result.html"
        method="GET"
        class="search-container fade-in"
      >
        <input
          type="text"
          name="query"
          placeholder="Search for a product"
          class="search-bar"
        />
      </form>

      <div class="hazard-header fade-in delay-1">
        <div class="hazard-title"></div>
        <div class="hazard-links">
          <a id="scoreLink" href="how-we-determine-scores.html"
            >HOW WE DETERMINE SCORES</a
          >
          <span class="divider">|</span>
          <a id="verifiedLink" href="learn-more-ewg-verified.html"
            >LEARN MORE ABOUT EWG VERIFIED®</a
          >
        </div>
      </div>

      <div class="hazard-container">
        <img
          src="assets/images/hazard-score-range.png"
          alt="Hazard Score Range"
          class="hazard-img fade-in delay-2"
        />
        <button class="activate-btn fade-in delay-3" id="activateBtn">
          Activate Cosafe
        </button>
      </div>

      <div class="ewg-products">
        <div class="fade-in delay-4">
          <div class="header-with-sort">
            <select id="sortOption" class="sort-select">
              <option value="default">Sort: Default</option>
              <option value="asc">Sort: A → Z</option>
              <option value="desc">Sort: Z → A</option>
            </select>
            <p class="center-text">
              HERE ARE THE PRODUCTS MATCHING YOUR SEARCH:
            </p>
          </div>
        </div>
        <div class="product-grid"></div>
      </div>
    </div>

    <div class="pagination">
      <button id="prevPage" disabled>Previous</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Next</button>
    </div>

    <div class="background-image"></div>

    <script>
      // Khởi tạo trạng thái CoSafe
      const button = document.getElementById("activateBtn");
      window.isCosafeActive = localStorage.getItem("isCosafeActive") === "true";
      button.textContent = window.isCosafeActive
        ? "Deactivate Cosafe"
        : "Activate Cosafe";

      button.addEventListener("click", function () {
        window.isCosafeActive = !window.isCosafeActive;
        localStorage.setItem("isCosafeActive", window.isCosafeActive);
        this.textContent = window.isCosafeActive
          ? "Deactivate Cosafe"
          : "Activate Cosafe";
        renderProducts(currentPage);
      });

      // Xử lý query từ URL
      const urlParams = new URLSearchParams(window.location.search);
      let query = urlParams.get("query") || "";
      if (query) {
        document.querySelector(".search-bar").value = query;
      }

      // Cập nhật link với query
      const scoreLink = document.getElementById("scoreLink");
      const verifiedLink = document.getElementById("verifiedLink");
      scoreLink.href = `how-we-determine-scores.html?query=${encodeURIComponent(
        query
      )}`;
      verifiedLink.href = `learn-more-ewg-verified.html?query=${encodeURIComponent(
        query
      )}`;

      // Xử lý tìm kiếm và hiển thị sản phẩm
      const itemsPerPage = 3;
      let currentPage = 1;
      let products = [];
      let totalPages = 1;
      const productGrid = document.querySelector(".product-grid");
      const prevBtn = document.getElementById("prevPage");
      const nextBtn = document.getElementById("nextPage");
      const pageInfo = document.getElementById("pageInfo");
      let currentSort = "default";

      // Hàm tìm kiếm sản phẩm từ API
      async function fetchProducts(searchQuery) {
        try {
          const response = await fetch("http://localhost:8000/safety", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: searchQuery }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
          }

          const data = await response.json();
          if (data.message === "Không tìm thấy sản phẩm") {
            showNotification("No products found for your search.");
            return [];
          }

          return data.products.map((product) => ({
            img: product.image || "assets/images/default.jpg",
            title: product.name,
            score: product.score,
          }));
        } catch (error) {
          console.error("Error fetching products:", error);
          showNotification(
            "An error occurred while searching. Please try again."
          );
          return [];
        }
      }

      // Hàm lấy màu sắc cho sản phẩm
      async function getColorForProduct(productName) {
        try {
          const response = await fetch("http://localhost:8000/safety", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: productName }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
          }

          const data = await response.json();
          if (data.message === "Không tìm thấy sản phẩm") {
            return null;
          }

          const score = data.products[0]?.score || 0;
          return score <= 3 ? "green" : score <= 6 ? "yellow" : "red";
        } catch (error) {
          console.error("Error getting color for product:", error);
          return null;
        }
      }

      // Hàm hiển thị thông báo
      function showNotification(message) {
        const notification = document.createElement("div");
        notification.className = "notification";
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      // Hàm hiển thị sản phẩm
      async function renderProducts(page) {
        productGrid.innerHTML = "";

        if (!products.length && query) {
          products = await fetchProducts(query);
          totalPages = Math.ceil(products.length / itemsPerPage);
        }

        let sortedProducts = [...products];
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        let paginatedItems = null;
        if (currentSort === "asc") {
          sortedProducts.sort((a, b) => a.title.localeCompare(b.title));
          paginatedItems = sortedProducts.slice(start, end);
        } else if (currentSort === "desc") {
          sortedProducts.sort((a, b) => b.title.localeCompare(a.title));
          paginatedItems = sortedProducts.slice(start, end);
        } else {
          paginatedItems = sortedProducts.slice(start, end);
        }

        paginatedItems.forEach((prod) => {
          const card = document.createElement("div");
          card.classList.add("product-card");
          card.innerHTML = `
            <img src="${prod.img}" alt="${prod.title}">
            <div class="title">${prod.title}</div>
          `;
          card.addEventListener("click", () => {
            const encodedTitle = encodeURIComponent(prod.title);
            window.location.href = `product-detail.html?query=${encodeURIComponent(
              query
            )}&title=${encodedTitle}`;
          });
          productGrid.appendChild(card);
        });

        if (window.isCosafeActive) {
          const titleElements = document.querySelectorAll(".title");
          for (const el of titleElements) {
            const productName = el.textContent.trim();
            el.classList.remove(
              "green-highlight",
              "yellow-highlight",
              "red-highlight"
            );
            const color = await getColorForProduct(productName);
            if (color) {
              el.classList.add(`${color}-highlight`);
            }
          }
        }

        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      }

      // Sự kiện phân trang
      prevNbr.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderProducts(currentPage);
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderProducts(currentPage);
        }
      });

      // Sự kiện sắp xếp
      document
        .getElementById("sortOption")
        .addEventListener("change", function () {
          currentSort = this.value;
          currentPage = 1;
          renderProducts(currentPage);
        });

      // Sự kiện tìm kiếm
      document
        .querySelector(".search-bar")
        .addEventListener("input", async (e) => {
          query = e.target.value.trim();
          currentPage = 1;
          products = [];
          await renderProducts(currentPage);
          // Cập nhật URL mà không reload trang
          history.pushState(
            {},
            "",
            `searching-result.html?query=${encodeURIComponent(query)}`
          );
          scoreLink.href = `how-we-determine-scores.html?query=${encodeURIComponent(
            query
          )}`;
          verifiedLink.href = `learn-more-ewg-verified.html?query=${encodeURIComponent(
            query
          )}`;
        });

      // Khởi động
      renderProducts(currentPage);
    </script>
  </body>
</html>
